<script>
    // --- UTILITY: Label Wrapping Logic ---
    function formatLabel(str, maxwidth) {
        var sections = [];
        var words = str.split(" ");
        var temp = "";
        words.forEach(function (item, index) {
            if (temp.length > 0) {
                var concat = temp + ' ' + item;
                if (concat.length > maxwidth) {
                    sections.push(temp);
                    temp = item;
                } else {
                    temp = concat;
                }
            } else {
                temp = item;
            }
            if (index === words.length - 1) {
                sections.push(temp);
            }
        });
        return sections;
    }

    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y', // Horizontal Bar Chart
        plugins: {
            tooltip: {
                backgroundColor: 'rgba(11, 17, 32, 0.95)',
                titleFont: { family: 'JetBrains Mono' },
                padding: 12,
                callbacks: {
                    title: function (context) {
                        return context[0].label.replaceAll(',', ' '); // Fix array commas in tooltip
                    },
                    label: function (context) {
                        return " Duration: " + context.raw + " Weeks";
                    }
                }
            },
            legend: { display: false } // We use the custom HTML legend above
        },
        scales: {
            x: {
                stacked: true,
                title: { display: true, text: 'Weeks Until First Bitcoin Trade', font: { family: 'JetBrains Mono' } },
                grid: { color: '#E2E8F0' },
                min: 0,
                max: 12
            },
            y: {
                stacked: true,
                grid: { display: false },
                ticks: {
                    font: { family: 'JetBrains Mono', size: 12 },
                    color: '#0F172A'
                }
            }
        }
    };

    // --- CHART: TIMELINE REALITY ---
    const ctxTimeline = document.getElementById('timelineChart').getContext('2d');

    // Revised Data: Only showing the SETUP BURDEN (Time to Go Live)
    // Option A: 1 step (2 weeks)
    // Option B: 3 steps (4 weeks + 4 weeks + 2 weeks)

    const labels = [
        "Option A: Standard",
        "Option B: Sovereign"
    ];

    new Chart(ctxTimeline, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                // --- SEGMENT 1: INITIAL PAPERWORK / APPROVAL ---
                {
                    label: 'Phase 1: Legal/Admin',
                    data: [2, 4], // A: 2wks, B: 4wks
                    backgroundColor: [
                        '#3B82F6', // Blue (A)
                        '#EA580C'  // Dark Orange (B)
                    ],
                    barThickness: 40,
                    borderRadius: 4
                },
                // --- SEGMENT 2: TECHNICAL SETUP ---
                {
                    label: 'Phase 2: Tech Setup',
                    data: [0, 4], // A: 0 (Done), B: 4wks (Keys)
                    backgroundColor: [
                        '#3B82F6',
                        '#F97316'  // Orange
                    ],
                    barThickness: 40,
                    borderRadius: 4,
                    borderSkipped: false
                },
                // --- SEGMENT 3: CUSTODY TRANSFER ---
                {
                    label: 'Phase 3: Final Transfer',
                    data: [0, 2], // A: 0 (Done), B: 2wks (Funding)
                    backgroundColor: [
                        '#3B82F6',
                        '#FDBA74'  // Light Orange
                    ],
                    barThickness: 40,
                    borderRadius: 4,
                    borderSkipped: false
                }
            ]
        },
        options: commonOptions
    });

    // --- CHART 2: LIQUIDITY PENALTY (Keep existing) ---
    const ctxPenalty = document.getElementById('penaltyChart').getContext('2d');

    new Chart(ctxPenalty, {
        type: 'bar',
        data: {
            labels: ['Gross Profit', 'Taxes & Penalty', 'You Keep'],
            datasets: [{
                label: 'Amount ($)',
                data: [40000, 18800, 21200],
                backgroundColor: [
                    '#E2E8F0', '#EF4444', '#10B981'
                ],
                borderRadius: 4,
                barThickness: 50
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { color: '#F1F5F9' } },
                x: { grid: { display: false }, ticks: { font: { family: 'Inter', weight: 'bold' } } }
            }
        }
    });
</script>